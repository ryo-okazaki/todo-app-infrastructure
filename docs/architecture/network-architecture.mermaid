graph TB
%% --- スタイル定義 ---
    classDef region fill:#fff,stroke:#879596,stroke-dasharray: 5 5,color:#000
    classDef account fill:#f9f9f9,stroke:#333,stroke-width:2px,stroke-dasharray: 10 5,color:#333
    classDef vpc fill:#f2fcfe,stroke:#248814,stroke-width:2px,color:#000
    classDef az fill:#fff,stroke:#d86613,stroke-dasharray: 3 3,color:#000
    classDef publicSubnet fill:#e7f2f1,stroke:#00a78e,color:#000
    classDef privateSubnet fill:#fdf3e5,stroke:#d86613,color:#000
    classDef service fill:#fff,stroke:#232f3e,stroke-width:2px,color:#000
    classDef dns fill:#e6f7ff,stroke:#0073bb,stroke-width:2px,color:#000

%% --- 外部 ---
    Internet(("Internet"))

%% --- Account C: Domain Account ---
    subgraph Account_C ["AWS Account C (Network)"]
        class Account_C account
        R53_Root["Route 53 Parent Zone (ryo-okazaki.com)"]:::dns
    end

%% --- Account B: Auth Account (Keycloak) ---
    subgraph Account_B ["AWS Account B (Auth)"]
        class Account_B account

        R53_Sub_B["Route 53 Hosted Zone (auth.ryo-okazaki.com)"]:::dns
        ACM_B["ACM Certificate (Regional)"]:::service
        SES_B["SES (Auth Email)"]:::service
        ECR_B["ECR (Keycloak Images)"]:::service
        Secrets_B["Secrets Manager (KC Params)"]:::service

        subgraph VPC_B ["VPC (10.1.0.0/16)"]
            class VPC_B vpc
            IGW_B["Internet Gateway"]:::service

            subgraph AZ1_B ["Availability Zone 1a"]
                class AZ1_B az
                subgraph Pub_Sub_B1 ["Public Subnet"]
                    class Pub_Sub_B1 publicSubnet
                    ALB_B1["ALB Node"]:::service
                    NAT_B1["NAT Gateway"]:::service
                end
                subgraph Priv_Sub_B1 ["Private Subnet"]
                    class Priv_Sub_B1 privateSubnet
                    KC_Fargate_1["ECS Fargate (Keycloak)"]:::service
                    RDS_KC_Primary[("RDS Primary (Keycloak)")]:::service
                end
            end

            subgraph AZ2_B ["Availability Zone 1c"]
                class AZ2_B az
                subgraph Pub_Sub_B2 ["Public Subnet"]
                    class Pub_Sub_B2 publicSubnet
                    ALB_B2["ALB Node"]:::service
                    NAT_B2["NAT Gateway"]:::service
                end
                subgraph Priv_Sub_B2 ["Private Subnet"]
                    class Priv_Sub_B2 privateSubnet
                    KC_Fargate_2["ECS Fargate (Keycloak)"]:::service
                    RDS_KC_Standby[("RDS Standby (Keycloak)")]:::service
                end
            end
        end
    end

%% --- Account A: App Account ---
    subgraph Account_A ["AWS Account A (App)"]
        class Account_A account

        subgraph Edge_A ["Edge & Regional Services"]
            style Edge_A fill:#fff,stroke:none
            R53_Sub_A["Route 53 Hosted Zone (app.ryo-okazaki.com)"]:::dns
            CF["CloudFront"]:::service
            S3_Assets[("S3 (Assets)")]:::service
            ECR_A["ECR (App Images)"]:::service
            SES_A["SES (App Email)"]:::service
            Secrets_A["Secrets Manager (App Params)"]:::service
            ACM_A["ACM (Global/Regional)"]:::service
        end

        subgraph VPC_A ["VPC (10.0.0.0/16)"]
            class VPC_A vpc
            IGW_A["Internet Gateway"]:::service

            subgraph AZ1_A ["Availability Zone 1a"]
                class AZ1_A az
                subgraph Pub_Sub_A1 ["Public Subnet"]
                    class Pub_Sub_A1 publicSubnet
                    ALB_A1["ALB Node"]:::service
                    NAT_A1["NAT Gateway"]:::service
                end
                subgraph Priv_Sub_A1 ["Private Subnet"]
                    class Priv_Sub_A1 privateSubnet
                    FE_Fargate_1["ECS Fargate (Next.js) + SC"]:::service
                    BE_Fargate_1["ECS Fargate (Express) + SC"]:::service
                    RDS_App_Primary[("RDS Primary (App)")]:::service
                end
            end

            subgraph AZ2_A ["Availability Zone 1c"]
                class AZ2_A az
                subgraph Pub_Sub_A2 ["Public Subnet"]
                    class Pub_Sub_A2 publicSubnet
                    ALB_A2["ALB Node"]:::service
                    NAT_A2["NAT Gateway"]:::service
                end
                subgraph Priv_Sub_A2 ["Private Subnet"]
                    class Priv_Sub_A2 privateSubnet
                    FE_Fargate_2["ECS Fargate (Next.js) + SC"]:::service
                    BE_Fargate_2["ECS Fargate (Express) + SC"]:::service
                    RDS_App_Standby[("RDS Standby (App)")]:::service
                end
            end
        end
    end

%% --- ネットワークフロー ---

%% 1. ドメイン
    R53_Root -.->|"NS Delegation"| R53_Sub_A & R53_Sub_B

%% 2. ユーザーアクセス
    Internet ==>|"HTTPS (app.ryo-okazaki.com)"| CF ==> IGW_A ==> ALB_A1 & ALB_A2
    ALB_A1 & ALB_A2 ==> FE_Fargate_1 & FE_Fargate_2

    Internet ==>|"HTTPS (auth.ryo-okazaki.com)"| IGW_B ==> ALB_B1 & ALB_B2
    ALB_B1 & ALB_B2 ==> KC_Fargate_1 & KC_Fargate_2

%% 3. コンテナ間通信 (Service Connect)
    FE_Fargate_1 == "Service Connect" ==> BE_Fargate_1
    FE_Fargate_2 == "Service Connect" ==> BE_Fargate_2
    linkStyle 10,11 stroke:#9370db,stroke-width:3px,color:#4b0082

%% 4. 認証連携 (Account A -> B Public)
    FE_Fargate_1 & BE_Fargate_1 -.-> NAT_A1
    FE_Fargate_2 & BE_Fargate_2 -.-> NAT_A2
    NAT_A1 & NAT_A2 -.->|"Internet"| ALB_B1 & ALB_B2

%% 5. 秘匿情報・イメージ・メール (Egress)
    FE_Fargate_1 & BE_Fargate_1 -.-> Secrets_A & ECR_A & SES_A
    KC_Fargate_1 & KC_Fargate_2 -.-> Secrets_B & ECR_B & SES_B

%% 6. データベース同期
    RDS_App_Primary -.->|"Replication"| RDS_App_Standby
    RDS_KC_Primary -.->|"Replication"| RDS_KC_Standby
